<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•iframeåˆ›å»ºæµç¨‹</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
        }
        .test-btn {
            padding: 10px 20px;
            margin: 10px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        #log {
            background: #000;
            padding: 15px;
            border: 1px solid #0f0;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        #gameContainer {
            width: 100%;
            height: 600px;
            border: 2px solid #0f0;
            margin-top: 20px;
            position: relative;
        }
        #gameContainer iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <h1>ğŸ” iframeåˆ›å»ºæµç¨‹æµ‹è¯•</h1>
    
    <div>
        <button class="test-btn" onclick="testDirectLoad()">ç›´æ¥æµ‹è¯•GamePixåŠ è½½</button>
        <button class="test-btn" onclick="testGamePageFlow()">æ¨¡æ‹Ÿæ¸¸æˆé¡µé¢æµç¨‹</button>
        <button class="test-btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div id="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
    
    <div id="gameContainer"></div>
    
    <!-- åŠ è½½å®é™…çš„JSæ–‡ä»¶ -->
    <script src="/js/utils.js"></script>
    <script src="/js/games.js"></script>
    
    <script>
        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ“';
            logEl.innerHTML += `[${time}] ${prefix} ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[Test] ${msg}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º\n';
        }
        
        async function testDirectLoad() {
            log('=== å¼€å§‹ç›´æ¥åŠ è½½æµ‹è¯• ===', 'info');
            
            const container = document.getElementById('gameContainer');
            container.innerHTML = '';
            
            // æµ‹è¯•æ¸¸æˆæ•°æ®
            const testGame = {
                id: 'body-drop-3d-gamepix',
                title: 'Body Drop 3D',
                iframeUrl: 'https://play.gamepix.com/body-drop-3d/embed?sid=1',
                source: 'GamePix',
                playCount: undefined // æ•…æ„è®¾ç½®ä¸ºundefinedæµ‹è¯•formatNumber
            };
            
            log('æµ‹è¯•æ¸¸æˆæ•°æ®: ' + JSON.stringify(testGame, null, 2));
            
            // æµ‹è¯•formatNumber
            try {
                const formatted = formatNumber(testGame.playCount);
                log('formatNumberæµ‹è¯•æˆåŠŸ: undefined -> ' + formatted, 'success');
            } catch (e) {
                log('formatNumberé”™è¯¯: ' + e.message, 'error');
                return;
            }
            
            // åˆ›å»ºiframe
            log('åˆ›å»ºiframeå…ƒç´ ...');
            const iframe = document.createElement('iframe');
            iframe.id = 'testGameIframe';
            
            log('è®¾ç½®iframeå±æ€§...');
            iframe.src = testGame.iframeUrl;
            iframe.setAttribute('allow', 'accelerometer; autoplay; fullscreen; gyroscope; payment; microphone; camera; geolocation');
            iframe.setAttribute('referrerpolicy', 'no-referrer-when-downgrade');
            
            log('å°†iframeæ·»åŠ åˆ°å®¹å™¨...');
            container.appendChild(iframe);
            
            log('iframeå·²æ·»åŠ åˆ°DOM', 'success');
            log('iframe.src = ' + iframe.src);
            log('iframeåœ¨æ–‡æ¡£ä¸­: ' + document.contains(iframe));
            
            // ç›‘å¬åŠ è½½äº‹ä»¶
            iframe.onload = () => {
                log('iframe onloadäº‹ä»¶è§¦å‘!', 'success');
            };
            
            iframe.onerror = (e) => {
                log('iframe onerroräº‹ä»¶: ' + e, 'error');
            };
        }
        
        async function testGamePageFlow() {
            log('=== æ¨¡æ‹Ÿæ¸¸æˆé¡µé¢å®Œæ•´æµç¨‹ ===', 'info');
            
            // æ¨¡æ‹ŸURLå‚æ•°
            const gameId = 'body-drop-3d-gamepix';
            log('æ¨¡æ‹ŸgameId: ' + gameId);
            
            // åŠ è½½æ¸¸æˆæ•°æ®
            log('è°ƒç”¨loadGameData()...');
            try {
                await loadGameData();
                log('æ¸¸æˆæ•°æ®åŠ è½½æˆåŠŸ', 'success');
                log('æ€»æ¸¸æˆæ•°: ' + (window.gamesData?.games?.length || 0));
            } catch (e) {
                log('åŠ è½½æ¸¸æˆæ•°æ®å¤±è´¥: ' + e.message, 'error');
                return;
            }
            
            // æŸ¥æ‰¾æ¸¸æˆ
            log('è°ƒç”¨getGameById("' + gameId + '")...');
            const game = getGameById(gameId);
            
            if (game) {
                log('æ‰¾åˆ°æ¸¸æˆ: ' + game.title, 'success');
                log('æ¸¸æˆURL: ' + game.iframeUrl);
                log('æ¸¸æˆæ¥æº: ' + game.source);
                
                // æµ‹è¯•updateGamePageContent
                log('æµ‹è¯•updateGamePageContent...');
                try {
                    // åˆ›å»ºå¿…è¦çš„DOMå…ƒç´ 
                    if (!document.getElementById('gameIframeWrapper')) {
                        const wrapper = document.createElement('div');
                        wrapper.id = 'gameIframeWrapper';
                        wrapper.innerHTML = '<iframe id="gameIframe"></iframe>';
                        document.getElementById('gameContainer').appendChild(wrapper);
                    }
                    
                    // è°ƒç”¨loadGameIframe
                    log('è°ƒç”¨loadGameIframe()...');
                    loadGameIframe(game);
                    
                    log('loadGameIframeæ‰§è¡Œå®Œæˆ', 'success');
                    
                    // æ£€æŸ¥iframe
                    const iframe = document.getElementById('gameIframe');
                    if (iframe && iframe.src) {
                        log('iframeåˆ›å»ºæˆåŠŸ!', 'success');
                        log('iframe.src = ' + iframe.src);
                    } else {
                        log('iframeæœªåˆ›å»ºæˆ–srcæœªè®¾ç½®', 'error');
                    }
                    
                } catch (e) {
                    log('æ‰§è¡Œå‡ºé”™: ' + e.message, 'error');
                    console.error(e);
                }
                
            } else {
                log('æœªæ‰¾åˆ°æ¸¸æˆID: ' + gameId, 'error');
            }
        }
        
        window.addEventListener('load', () => {
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>